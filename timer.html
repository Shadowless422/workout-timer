<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <title>Workout Timer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            background-color: #f2f33d;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;  /* Ensure the container takes the full height */
            width: 100%;
            text-align: center;
        }

        .header {
            flex: 0 0 10%;
            display: flex;
            justify-content: center;
            border: 1px solid black;
        }

        .header div {
            flex: auto;
            background-color: black; //#333;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 5vmax;
        }

        .main-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #timer {
            font-size: 35vw;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            color: black;
        }

        .bottom-bar {
            flex: 0 0 10%;
            display: flex;
            justify-content: space-between;
        }

        .bottom-bar div {
            flex: 1;
            background-color: black; //#333;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4vw;
            border: 1px solid black;
        }

        .bottom-bar-label {
            font-size: 2.6vw;
        }
    </style>
</head>
<body id="timer-background">
    <div class='container'>
        <div class='header'>
            <div id='phase'></div>
        </div>
        <div class='main-content'>
            <span id='timer'></span>
        </div>
        <div class='bottom-bar'>
            <div class='left'>
                <span id='round' style='color: dodgerblue'></span>
                <span>&nbsp;</span>
                <span class='bottom-bar-label' id='rounds-left-text'></span>
            </div>
            <div class='center' id='info-separator' style='background-color: #f2f33d; border: 0'></div>
            <div class='right'>
                <span id='cycle' style='color: #f2f33d'></span>
                <span>&nbsp;</span>
                <span class='bottom-bar-label' id='cycles-left-text'></span>
            </div>
        </div>
    </div>
</body>
<script src='/socket.io/socket.io.js'></script>
<script>
    const socket = io(); // Connect to the server

    // Listen for timer updates from the server
    // TODO: add feedback sounds for phase changes and 3,2,1 time left
    socket.on('timer-update', (timerState, timerSettings) => {
        console.log(timerState)
        updatePhaseAndTimer(timerState.phase, timerState.timeLeft);
        updateRoundsLeftText(timerSettings.rounds, timerState.round);
        updateCyclesLeftText(timerSettings.cycles, timerState.cycle);
    });
    
    // Utility function to format time as mm:ss
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
    
    // Function to update the phase with the right text
    function updatePhaseAndTimer(phase, timeLeft) {
        let phaseText;
        let timerTextColor;
        let timerBgColor;

        switch (phase) {
            case 'Prepare':
                phaseText = 'PREPARAZIONE';
                timerBgColor = '#f2f33d';
                timerTextColor = 'black';
                break;
            case 'Work':
                phaseText = 'ALLENAMENTO';
                timerBgColor = '#92f443';
                timerTextColor = 'black';
                break;
            case 'Rest':
                phaseText = 'RIPOSO';
                timerBgColor = '#e7372b';
                timerTextColor = 'white';
                break;
            case 'Rest Between Cycles':
                phaseText = 'PAUSA PRIMA DEL PROSSIMO CICLO'
                timerBgColor = '#f2f33d';
                timerTextColor = 'black';
                break;
            default:
                console.warn(`Unknown state: ${phase}`)
        }
        document.getElementById('phase').textContent = phaseText;
        document.getElementById('timer').textContent = formatTime(timeLeft);
        document.getElementById('timer').style.color = timerTextColor;
        document.getElementById('timer-background').style.backgroundColor = timerBgColor;
        document.getElementById('info-separator').style.backgroundColor = timerBgColor;
        
        // TODO: add sound effect on changes (probably not here though)
    }

    function updateRoundsLeftText(totalRounds, currentRound) {
        const roundsLeft = totalRounds - currentRound;
        document.getElementById('round').textContent = `${roundsLeft}`;
        document.getElementById('rounds-left-text').textContent = roundsLeft === 1 ? 'ROUND RIMANENTE' : 'ROUND RIMANENTI'
    }

    function updateCyclesLeftText(totalCycles, currentCycle) {
        const cyclesLeft = totalCycles - currentCycle;
        document.getElementById('cycle').textContent = `${cyclesLeft}`;
        document.getElementById('cycles-left-text').textContent = cyclesLeft === 1 ? 'CICLO RIMANENTE' : 'CICLI RIMANENTI'
    }
</script>
</html>